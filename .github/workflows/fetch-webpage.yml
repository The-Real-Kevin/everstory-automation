name: Download Homepage Every 5 Minutes

on:
  schedule:
    - cron: '0 */2 * * *'  # Every day at 2 
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŒ Download page
        run: |
          mkdir -p downloads
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          curl -L https://the-real-kevin.github.io -o downloads/homepage_${TIMESTAMP}.html
          cp downloads/homepage_${TIMESTAMP}.html downloads/homepage_latest.html
          echo "Downloaded at ${TIMESTAMP}"
          ls -lh downloads/homepage_latest.html
      
      - name: ğŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: homepage-${{ github.run_number }}
          path: downloads/*.html
          retention-days: 3

      - name: ğŸ”„ Check for changes
        run: |
          if [ -f downloads/homepage_previous.html ]; then
            if diff downloads/homepage_latest.html downloads/homepage_previous.html > /dev/null; then
              echo "âœ… No changes detected"
            else
              echo "ğŸ†• Page has changed!"
            fi
          else
            echo "ğŸ“ First run - no previous version to compare"
          fi
          
          # Save current as previous for next run
          cp downloads/homepage_latest.html downloads/homepage_previous.html

name: Fetch and Compare Google Sheets

on:
  schedule:
    - cron: '0 */2 * * *'  # Every day at 2 
  workflow_dispatch:

jobs:
  fetch-and-compare:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # Simulate downloading current sheet
      - name: ğŸ“Š Download current sheet
        run: |
          mkdir -p data
          
          # SIMULATE: In real version, this would fetch from Google Sheets
          # For now, create a dummy CSV with some data
          cat > data/moderated_responses_latest.csv << 'EOF'
          Verification,Moderator,Timestamp,Item_Name,Description
          verified,John Doe,2024-01-01,Apple,A red fruit
          verified,Jane Smith,2024-01-02,Banana,A yellow fruit
          verified,Bob Johnson,2024-01-03,Cherry,A small red fruit
          verified,Alice Williams,2024-01-04,Date,A sweet brown fruit
          EOF
          
          echo "âœ… Downloaded current sheet"
          echo "Current sheet contents:"
          cat data/moderated_responses_latest.csv
      
      # Download previous version from artifacts or create dummy
      - name: ğŸ“¥ Get previous version
        continue-on-error: true
        run: |
          # Check if previous version exists
          if [ -f data/moderated_responses_previous.csv ]; then
            echo "âœ… Previous version found"
          else
            echo "âš ï¸  No previous version - creating dummy"
            # Create a previous version with fewer rows
            cat > data/moderated_responses_previous.csv << 'EOF'
          Verification,Moderator,Timestamp,Item_Name,Description
          verified,John Doe,2024-01-01,Apple,A red fruit
          verified,Jane Smith,2024-01-02,Banana,A yellow fruit
          EOF
          fi
          
          echo "Previous sheet contents:"
          cat data/moderated_responses_previous.csv
      
      # Compare sheets
      - name: ğŸ” Compare sheets
        run: |
          python compare_sheets.py
      
      # Show results
      - name: ğŸ“‹ Show new rows
        run: |
          if [ -f data/new_rows.csv ]; then
            echo "New rows found:"
            cat data/new_rows.csv
          else
            echo "No new rows file generated"
          fi
      
      # Save current as previous for next run
      - name: ğŸ’¾ Update previous version
        run: |
          cp data/moderated_responses_latest.csv data/moderated_responses_previous.csv
          echo "âœ… Updated previous version for next comparison"
      
      # Upload results
      - name: ğŸ“¤ Upload results
        uses: actions/upload-artifact@v4
        with:
          name: comparison-results-${{ github.run_number }}
          path: |
            data/moderated_responses_latest.csv
            data/moderated_responses_previous.csv
            data/new_rows.csv
          retention-days: 7